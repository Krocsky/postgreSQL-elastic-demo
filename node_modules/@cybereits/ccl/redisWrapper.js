'use strict';

/* eslint-disable prefer-rest-params */

var SLICE = Array.prototype.slice;
var ACTIONS = 'del dump exists expire expireat keys migrate move object persist pexpire pexpireat pttl randomkey rename renamenx restore sort ttl type scan append bitcount bitop decr decrby get getbit getrange getset incr incrby incrbyfloat mget mset msetnx psetex set setbit setex setnx setrange strlen hdel hexists hget hgetall hincrby hincrbyfloat hkeys hlen hmget hmset hset hsetnx hvals hscan blpop brpop brpoplpush lindex linsert llen lpop lpush lpushx lrange lrem lset ltrim rpop rpoplpush rpush rpushx sadd scard sdiff sdiffstore sinter sinterstore sismember smembers smove spop srandmember srem sunion sunionstore sscan zadd zcard zcount zincrby zrange zrangebyscore zrank zrem  zremrangebyrank zremrangebyscore zrevrange zrevrangebyscore zrevrank zscore zunionstore zinterstore zscan psubscribe publish pubsub punsubscribe subscribe unsubscribe discard exec multi unwatch watch info'.split(' ');
var EXTENSIONS = ['getObj', 'setObj'];

var wrapper = function wrapper(connection) {
  ACTIONS.forEach(function (funcName) {
    if (typeof connection[funcName] === 'function') {
      var __originFunc = connection[funcName];
      connection[funcName] = function () {
        var args = SLICE.call(arguments, 0);
        return new Promise(function (resolve, reject) {
          __originFunc.apply(connection, args.concat(function (error, replies) {
            if (error) {
              console.error(error.message);
              reject(error);
            } else {
              resolve(replies);
            }
            connection.quit();
          }));
        });
      };
    }
  });

  // extensions

  /**
   * 获取一个对象
   * @param {string} key Key
   */
  connection.getObj = function (key) {
    return connection.get(key).then(function (value) {
      if (value) {
        return JSON.parse(value);
      } else {
        return null;
      }
    });
  };

  /**
   * 保存一个对象
   * @param {string} key Key
   * @param {string|object} value Value
   * @param {number|null} timeout Timeout limitation
   */
  connection.setObj = function (key, value, timeout) {
    if (timeout) {
      return connection.set(key, typeof value === 'string' ? value : JSON.stringify(value), 'EX', timeout);
    } else {
      return connection.set(key, typeof value === 'string' ? value : JSON.stringify(value));
    }
  };

  return connection;
};

var init = function init(redis, configs) {

  var connGen = function connGen() {
    var connection = redis.createClient(configs.port, configs.host, Object.assign({
      retry_strategy: function retry_strategy(options) {
        if (options.error && options.error.code === 'ECONNREFUSED') {
          console.error('Redis server refused the connection.');
        }
        // retry 2 times then return a built in error
        if (options.total_retry_time > 2000 * 2) {
          return undefined;
        }
        return 2000; // retry in 2s
      }
    }, configs));

    connection.on('error', function (ex) {
      console.error(ex.message);
    });

    return wrapper(connection);
  };

  var __helper = {};

  ACTIONS.concat(EXTENSIONS).forEach(function (funcName) {
    __helper[funcName] = function () {
      var args = SLICE.call(arguments, 0);
      return connGen()[funcName].apply(null, args).catch(function (ex) {
        console.error(ex.message);
        return null;
      });
    };
  });

  return __helper;
};

module.exports = init;